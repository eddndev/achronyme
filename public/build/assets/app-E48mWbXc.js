import{i as I,v as F,a as V}from"./validation-BT8GwmWI.js";import{e as w,p as y}from"./mathjs-CqmDO44L.js";import{C as R,r as O}from"./chart-Co7ClN-s.js";const A=50;function Y(t){try{if(!t||t.length===0)throw new Error("No se proporcionaron funciones para el cálculo.");const e=t.map(i=>{try{return{userFunc:y(i.definition).compile(),a:w(i.domainStart),b:w(i.domainEnd)}}catch(_){throw new Error(`Error al procesar la función "${i.definition}" o sus dominios: ${_.message}`)}}),r=e[0].a,s=e[e.length-1].b-r;if(s<=0)throw new Error("El período total (desde el inicio del primer dominio hasta el fin del último) debe ser positivo.");const d=[],u=[];let h=0;for(const i of e)h+=I(_=>i.userFunc.evaluate({t:_}),i.a,i.b);const l=2/s*h;for(let i=1;i<=A;i++){let _=0,m=0;for(const c of e)_+=I(p=>c.userFunc.evaluate({t:p})*Math.cos(2*Math.PI*i*p/s),c.a,c.b),m+=I(p=>c.userFunc.evaluate({t:p})*Math.sin(2*Math.PI*i*p/s),c.a,c.b);d[i]=2/s*_,u[i]=2/s*m}return{success:!0,coeffs:{a0:l,an:d,bn:u,period:s,domainStart:r}}}catch(e){return console.error("Error en el cálculo de coeficientes:",e),{success:!1,error:e.message}}}function $(){return{calculationMode:"calculate",isLoading:!1,errorMessage:"",resizeObserver:null,nextId:2,functions:[{id:1,definition:"t",domainStart:"-pi",domainEnd:"pi",definitionError:null,domainStartError:null,domainEndError:null}],piecewiseCoeffs:null,coeff_a0_str:"0",coeff_an_str:"(2*(-1)^(n+1))/n",coeff_bn_str:"0",coeff_a0_error:null,coeff_an_error:null,coeff_bn_error:null,renderOriginal:["original"],renderSeries:["series"],terms_n:10,init(){console.log("[Alpine] Initializing fourierState..."),window.FourierSeriesChart.init({functions:[],renderOriginal:[],renderSeries:[],terms_n:this.terms_n,piecewiseCoeffs:null});const t=document.getElementById("chartContainer");t&&(this.resizeObserver=new ResizeObserver(()=>{window.FourierSeriesChart.chart&&window.FourierSeriesChart.chart.resize()}),this.resizeObserver.observe(t),console.log("[Alpine] ResizeObserver attached to chart container")),this.calculateAndRedraw(),this.$watch("renderOriginal",()=>this.prepareAndRedraw(!1)),this.$watch("renderSeries",()=>this.prepareAndRedraw(!1)),this.$watch("terms_n",()=>this.prepareAndRedraw(!1)),this.$watch("calculationMode",e=>{e==="coefficients"?this.renderOriginal=[]:this.renderOriginal=["original"],this.prepareAndRedraw(!1)})},addFunction(){const t=this.functions[this.functions.length-1];this.functions.push({id:this.nextId++,definition:"0",domainStart:t.domainEnd,domainEnd:"",definitionError:null,domainStartError:null,domainEndError:null})},removeFunction(t){if(this.functions.length>1){const e=this.functions.findIndex(r=>r.id===t);if(e>-1){if(e>0&&e<this.functions.length-1){const r=this.functions[e-1],n=this.functions[e+1];n&&(n.domainStart=r.domainEnd)}this.functions=this.functions.filter(r=>r.id!==t)}}},validate(){this.errorMessage="";let t=!1;if(this.functions.forEach(e=>{e.definitionError=null,e.domainStartError=null,e.domainEndError=null}),this.functions.length===0)return this.errorMessage="Debe haber al menos una función definida.",!1;for(let e=0;e<this.functions.length;e++){const r=this.functions[e],n=V(r.definition);n.isValid||(r.definitionError=n.error,t=!0);const s=F(r.domainStart);s.isValid||(r.domainStartError=s.error,t=!0);const d=F(r.domainEnd);if(d.isValid||(r.domainEndError=d.error,t=!0),e>0){const u=this.functions[e-1];try{if(F(u.domainEnd).isValid&&F(r.domainStart).isValid){const h=w(u.domainEnd),l=w(r.domainStart);if(h!==l){t=!0;const i=`Debe coincidir con el dominio anterior (${h})`;r.domainStartError=r.domainStartError?`${r.domainStartError}. ${i}`:i}}}catch{}}}return!t},validateCoefficients(){this.errorMessage="";let t=!1;this.coeff_a0_error=null,this.coeff_an_error=null,this.coeff_bn_error=null;const e=F(this.coeff_a0_str);e.isValid||(this.coeff_a0_error=e.error,t=!0);const r=V(this.coeff_an_str,"n");r.isValid||(this.coeff_an_error=r.error,t=!0);const n=V(this.coeff_bn_str,"n");return n.isValid||(this.coeff_bn_error=n.error,t=!0),!t},async calculateAndRedraw(){if(this.isLoading=!0,this.errorMessage="",window.FourierSeriesChart.resetScales(),!(this.calculationMode==="calculate"?this.validate():this.validateCoefficients())){this.isLoading=!1;return}try{if(this.calculationMode==="calculate"){const e=Y(this.functions);if(e.success)this.piecewiseCoeffs=e.coeffs;else throw new Error(e.error||"Ocurrió un error desconocido.")}else if(this.evaluateCoefficientExpressions(),this.errorMessage){this.isLoading=!1;return}window.FourierSeriesChart.redraw(this.getChartData())}catch(e){console.error("[Alpine] Calculation Error:",e),this.errorMessage=e.message,this.piecewiseCoeffs=null,window.FourierSeriesChart.redraw(this.getChartData())}finally{this.isLoading=!1}},evaluateCoefficientExpressions(){try{this.errorMessage="";const t=-Math.PI,r=Math.PI-t;if(r<=0)throw new Error("El período total debe ser positivo.");const n=w(this.coeff_a0_str),s=y(this.coeff_an_str).compile(),d=y(this.coeff_bn_str).compile(),u=[],h=[];for(let l=1;l<=50;l++)u[l]=s.evaluate({n:l}),h[l]=d.evaluate({n:l});this.piecewiseCoeffs={a0:n,an:u,bn:h,period:r,domainStart:t}}catch(t){this.errorMessage=`Error en la expresión del coeficiente: ${t.message}`,this.piecewiseCoeffs=null}},prepareAndRedraw(t=!0){if(t){this.calculateAndRedraw();return}window.FourierSeriesChart.redraw(this.getChartData())},getChartData(){return{functions:this.functions,renderOriginal:this.renderOriginal,renderSeries:this.renderSeries,terms_n:this.terms_n,piecewiseCoeffs:this.piecewiseCoeffs}}}}window.fourierState=$;R.register(...O);window.FourierSeriesChart={chart:null,currentMinY:null,currentMaxY:null,resetScales(){this.currentMinY=null,this.currentMaxY=null},init(t){const e=document.getElementById("fourierChart"),r=document.getElementById("chartContainer");if(!e||!r){console.error("Chart canvas or container not found!");return}this.chart&&this.chart.destroy(),this.resetScales(),e.style.width="100%",e.style.height="100%",e.style.maxWidth="100%";const n={type:"line",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,resizeDelay:100,scales:{x:{title:{display:!0,text:"t"},ticks:{maxTicksLimit:20}},y:{title:{display:!0,text:"f(t)"}}},plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},elements:{point:{radius:0}}}};this.chart=new R(e,n),this.redraw(t)},redraw(t){if(!this.chart||!t||!t.functions){console.warn("Redraw failed: Chart instance or data is missing."),this.chart&&(this.chart.data.labels=[],this.chart.data.datasets=[],this.chart.update("none"));return}const{functions:e,renderOriginal:r,renderSeries:n,terms_n:s,piecewiseCoeffs:d}=t,u=n.includes("series")&&!!d,h=r.includes("original")&&e.length>0,l=[],i=[],_=500;let m,c;if(h){m=e.length>0?w(e[0].domainStart):0,c=e.length>0?w(e[e.length-1].domainEnd):1;const a=c-m;c=m+2*a}else u?(m=d.domainStart,c=d.domainStart+2*d.period):(m=-Math.PI,c=Math.PI);const x=c-m,D=x>0?x/_:.1,p=[];for(let a=m;a<=c;a+=D)p.push(a.toFixed(2));if(h){const a=e.map(f=>{try{return{compiled:y(f.definition).compile(),start:w(f.domainStart),end:w(f.domainEnd)}}catch{return null}}).filter(f=>f!==null),E=a[0].start,g=a[a.length-1].end-E,M=[];for(const f of p){const C=parseFloat(f);let b=null,o=(C-E)%g;o<0&&(o+=g),o+=E;const P=a.find(v=>o>=v.start-1e-9&&o<=v.end+1e-9);if(P){const v=this.evaluateCompiledFunction(P.compiled,o);isFinite(v)&&(b=v,i.push(v))}M.push(b)}l.push({label:"f(t)",data:M,borderColor:"rgb(59, 130, 246)",borderWidth:2,borderDash:[5,5],tension:.1})}if(u){const{a0:a,an:E,bn:S,period:g}=d,M=[];for(const f of p){const C=parseFloat(f);let b=a/2;for(let o=1;o<=s;o++)E[o]!==void 0&&S[o]!==void 0&&(b+=E[o]*Math.cos(2*Math.PI*o*C/g),b+=S[o]*Math.sin(2*Math.PI*o*C/g));M.push(b),isFinite(b)&&i.push(b)}l.push({label:`Serie de Fourier (N=${s})`,data:M,borderColor:"rgb(220, 38, 38)",borderWidth:2,tension:.1})}if(i.length>0){let a=Math.min(...i),E=Math.max(...i);(this.currentMinY===null||a<this.currentMinY)&&(this.currentMinY=a),(this.currentMaxY===null||E>this.currentMaxY)&&(this.currentMaxY=E);let S=this.currentMinY,g=this.currentMaxY;S===g&&(S-=1,g+=1);const f=(g-S)*.1;this.chart.options.scales?.y&&(this.chart.options.scales.y.min=S-f,this.chart.options.scales.y.max=g+f)}else this.resetScales(),this.chart.options.scales?.y&&(delete this.chart.options.scales.y.min,delete this.chart.options.scales.y.max);this.chart.data.labels=p,this.chart.data.datasets=l,this.chart.update("none")},evaluateCompiledFunction(t,e){try{const r=t.evaluate({t:e,pi:Math.PI});return typeof r=="number"&&isFinite(r)?r:NaN}catch(r){return console.error("Error evaluating compiled function:",r),NaN}}};
