import{i as M,a as C,v as E}from"./validation-BT8GwmWI.js";import{e as h,p as y}from"./mathjs-CqmDO44L.js";import{C as w,r as I}from"./chart-Co7ClN-s.js";function R(t,n,i,r){try{if(!t||t.length===0)throw new Error("No se proporcionaron funciones f(t) para el cálculo.");if(!n||n.length===0)throw new Error("No se proporcionaron funciones g(t) para el cálculo.");const[e,l]=i;if(l<=e)throw new Error("El rango de tiempo debe ser válido (tMax > tMin).");r<10;const o=[],a=[],s=(l-e)/r,d={start:t[0].domainStart,end:t[t.length-1].domainEnd},g={start:n[0].domainStart,end:n[n.length-1].domainEnd},b=c=>{for(const u of t)if(c>=u.domainStart-1e-9&&c<=u.domainEnd+1e-9)try{const f=u.compiled.evaluate({t:c});return isFinite(f)?f:0}catch{return 0}return 0},p=c=>{for(const u of n)if(c>=u.domainStart-1e-9&&c<=u.domainEnd+1e-9)try{const f=u.compiled.evaluate({t:c});return isFinite(f)?f:0}catch{return 0}return 0};for(let c=e;c<=l;c+=s){o.push(c);const u=Math.max(d.start,c-g.end),f=Math.min(d.end,c-g.start);let m=0;u<f&&(m=M(F=>{const v=b(F),S=p(c-F);return v*S},u,f,1e3)),a.push(m)}return console.log(`[Convolution] Calculated ${o.length} points`),console.log(`[Convolution] t range: [${o[0].toFixed(2)}, ${o[o.length-1].toFixed(2)}]`),{success:!0,t:o,result:a}}catch(e){return console.error("[Convolution] Calculation error:",e),{success:!1,t:[],result:[],error:e.message}}}function V(t,n){const i=t[0].domainStart,r=t[t.length-1].domainEnd,e=n[0].domainStart,l=n[n.length-1].domainEnd,o=i+e,a=r+l;return[o,a]}function G(t,n=500){if(!t||t.length===0)return{tau:[],values:[]};const i=[],r=[],e=t[0].domainStart,l=t[t.length-1].domainEnd,o=(l-e)/n;for(let a=e;a<=l;a+=o){i.push(a);let s=0;for(const d of t)if(a>=d.domainStart-1e-9&&a<=d.domainEnd+1e-9){try{s=d.compiled.evaluate({t:a}),isFinite(s)||(s=0)}catch{s=0}break}r.push(s)}return{tau:i,values:r}}function k(t,n,i,r=500){const e=[],l=[],[o,a]=i,s=(a-o)/r;for(let d=o;d<=a;d+=s){e.push(d);const g=n-d;let b=0;for(const p of t)if(g>=p.domainStart-1e-9&&g<=p.domainEnd+1e-9){try{b=p.compiled.evaluate({t:g}),isFinite(b)||(b=0)}catch{b=0}break}l.push(b)}return{tau:e,values:l}}function D(t,n){const i=Math.min(t.values.length,n.values.length),r=[];for(let e=0;e<i;e++)r.push(t.values[e]*n.values[e]);return r}function A(){return{isLoading:!1,errorMessage:"",resizeObserver:null,renderOptions:["f","g","product","result"],currentTime:0,manualRange:!1,tInitial:"-10",tInitial_error:null,tFinal:"10",tFinal_error:null,nextIdF:2,functionsF:[{id:1,definition:"exp(-abs(t))",domainStart:"-5",domainEnd:"5",definitionError:null,domainStartError:null,domainEndError:null}],nextIdG:2,functionsG:[{id:1,definition:"1",domainStart:"-1",domainEnd:"1",definitionError:null,domainStartError:null,domainEndError:null}],cachedData:{compiledF:null,compiledG:null,convResult:null,fData:null,tauMin:null,tauMax:null,tRange:null},get tInitialNumeric(){try{return h(this.tInitial)}catch{return-10}},get tFinalNumeric(){try{return h(this.tFinal)}catch{return 10}},init(){console.log("[Alpine] Initializing convolutionState..."),window.FunctionsChart.init(),window.ResultChart.init(),[document.getElementById("functionsContainer"),document.getElementById("resultContainer")].forEach(n=>{n&&(new ResizeObserver(()=>{window.FunctionsChart.chart&&window.FunctionsChart.chart.resize(),window.ResultChart.chart&&window.ResultChart.chart.resize()}).observe(n),console.log("[Alpine] ResizeObserver attached to container"))}),this.$watch("renderOptions",()=>{console.log("[Alpine] Render options changed:",this.renderOptions),this.updateCharts()}),this.$watch("currentTime",()=>{console.log("[Alpine] Current time changed:",this.currentTime),this.updateCharts()}),this.$watch("manualRange",()=>{console.log("[Alpine] Manual range:",this.manualRange)}),this.calculateConvolution()},addFunctionF(){const t=this.functionsF[this.functionsF.length-1];this.functionsF.push({id:this.nextIdF++,definition:"0",domainStart:t.domainEnd,domainEnd:"",definitionError:null,domainStartError:null,domainEndError:null})},removeFunctionF(t){if(this.functionsF.length>1){const n=this.functionsF.findIndex(i=>i.id===t);if(n>-1){if(n>0&&n<this.functionsF.length-1){const i=this.functionsF[n-1],r=this.functionsF[n+1];r&&(r.domainStart=i.domainEnd)}this.functionsF=this.functionsF.filter(i=>i.id!==t)}}},addFunctionG(){const t=this.functionsG[this.functionsG.length-1];this.functionsG.push({id:this.nextIdG++,definition:"0",domainStart:t.domainEnd,domainEnd:"",definitionError:null,domainStartError:null,domainEndError:null})},removeFunctionG(t){if(this.functionsG.length>1){const n=this.functionsG.findIndex(i=>i.id===t);if(n>-1){if(n>0&&n<this.functionsG.length-1){const i=this.functionsG[n-1],r=this.functionsG[n+1];r&&(r.domainStart=i.domainEnd)}this.functionsG=this.functionsG.filter(i=>i.id!==t)}}},validate(){this.errorMessage="";let t=!1;if(this.functionsF.forEach(n=>{n.definitionError=null,n.domainStartError=null,n.domainEndError=null}),this.functionsG.forEach(n=>{n.definitionError=null,n.domainStartError=null,n.domainEndError=null}),this.functionsF.length===0)return this.errorMessage="Debe haber al menos una función f(t) definida.",!1;for(let n=0;n<this.functionsF.length;n++){const i=this.functionsF[n],r=C(i.definition,"t");r.isValid||(i.definitionError=r.error,t=!0);const e=E(i.domainStart);e.isValid||(i.domainStartError=e.error,t=!0);const l=E(i.domainEnd);if(l.isValid||(i.domainEndError=l.error,t=!0),n>0){const o=this.functionsF[n-1];try{if(E(o.domainEnd).isValid&&E(i.domainStart).isValid){const a=h(o.domainEnd),s=h(i.domainStart);if(a!==s){t=!0;const d=`Debe coincidir con el dominio anterior (${a})`;i.domainStartError=i.domainStartError?`${i.domainStartError}. ${d}`:d}}}catch{}}}if(this.functionsG.length===0)return this.errorMessage="Debe haber al menos una función g(t) definida.",!1;for(let n=0;n<this.functionsG.length;n++){const i=this.functionsG[n],r=C(i.definition,"t");r.isValid||(i.definitionError=r.error,t=!0);const e=E(i.domainStart);e.isValid||(i.domainStartError=e.error,t=!0);const l=E(i.domainEnd);if(l.isValid||(i.domainEndError=l.error,t=!0),n>0){const o=this.functionsG[n-1];try{if(E(o.domainEnd).isValid&&E(i.domainStart).isValid){const a=h(o.domainEnd),s=h(i.domainStart);if(a!==s){t=!0;const d=`Debe coincidir con el dominio anterior (${a})`;i.domainStartError=i.domainStartError?`${i.domainStartError}. ${d}`:d}}}catch{}}}if(this.manualRange){this.tInitial_error=null,this.tFinal_error=null;const n=E(this.tInitial);n.isValid||(this.tInitial_error=n.error,t=!0);const i=E(this.tFinal);if(i.isValid||(this.tFinal_error=i.error,t=!0),n.isValid&&i.isValid){const r=h(this.tInitial);h(this.tFinal)<=r&&(this.tFinal_error="t final debe ser mayor que t inicial",t=!0)}}return!t},async calculateConvolution(){if(this.isLoading=!0,this.errorMessage="",!this.validate()){this.isLoading=!1;return}try{console.log("[Alpine] Calculating Convolution...");const t=this.functionsF.map(s=>({compiled:y(s.definition).compile(),domainStart:h(s.domainStart),domainEnd:h(s.domainEnd)})),n=this.functionsG.map(s=>({compiled:y(s.definition).compile(),domainStart:h(s.domainStart),domainEnd:h(s.domainEnd)}));let i;this.manualRange?i=[h(this.tInitial),h(this.tFinal)]:(i=V(t,n),this.tInitial=i[0].toString(),this.tFinal=i[1].toString()),console.log(`[Alpine] Time range: [${i[0]}, ${i[1]}]`);const r=R(t,n,i,500);if(!r.success)throw new Error(r.error||"Error en el cálculo de la convolución");const e=G(t,500),l=Math.min(e.tau[0],n[0].domainStart),o=Math.max(e.tau[e.tau.length-1],n[n.length-1].domainEnd);this.cachedData={compiledF:t,compiledG:n,convResult:r,fData:e,tauMin:l,tauMax:o,tRange:i};const a=(i[0]+i[1])/2;this.currentTime=Math.round(a*10)/10,this.updateCharts(),console.log("[Alpine] Convolution calculation completed successfully")}catch(t){console.error("[Alpine] Calculation Error:",t),this.errorMessage=t.message}finally{this.isLoading=!1}},updateCharts(){if(!this.cachedData.fData||!this.cachedData.convResult)return;const{compiledG:t,fData:n,tauMin:i,tauMax:r,convResult:e,tRange:l}=this.cachedData,o=this.renderOptions.includes("f"),a=this.renderOptions.includes("g"),s=this.renderOptions.includes("product"),d=this.renderOptions.includes("result"),g=k(t,this.currentTime,[i,r],500),b=D(n,g);if(window.FunctionsChart.redraw({tau:n.tau,f:o?n.values:[],g:a?g.values:[],product:s?b:void 0}),d){let p=0;const c=this.currentTime;let u=-1;for(let m=0;m<e.t.length-1;m++)if(e.t[m]<=c&&e.t[m+1]>=c){u=m;break}if(u>=0&&u<e.t.length-1){const m=e.t[u],x=e.t[u+1],F=e.result[u],v=e.result[u+1],S=(c-m)/(x-m);p=F+S*(v-F)}else c<=e.t[0]?p=e.result[0]:c>=e.t[e.t.length-1]&&(p=e.result[e.result.length-1]);const f={t:this.currentTime,value:p};window.ResultChart.redraw({t:e.t,result:e.result,currentPoint:f})}else window.ResultChart.clear()}}}window.convolutionState=A;w.register(...I);window.FunctionsChart={chart:null,init(){const t=document.getElementById("functionsChart"),n=document.getElementById("functionsContainer");if(!t||!n){console.error("Functions chart canvas or container not found!");return}this.chart&&this.chart.destroy(),t.style.width="100%",t.style.height="100%",t.style.maxWidth="100%";const i={type:"line",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,scales:{x:{title:{display:!0,text:"τ"},ticks:{maxTicksLimit:15,callback:function(r,e,l){const o=parseFloat(this.getLabelForValue(r));return Math.abs(o)<1e-10?"0":Math.abs(o)<.01||Math.abs(o)>1e3?o.toExponential(2):o.toFixed(2)}}},y:{title:{display:!0,text:"Amplitud"},ticks:{callback:function(r){const e=r;return Math.abs(e)<1e-10?"0":Math.abs(e)<.01||Math.abs(e)>1e3?e.toExponential(2):e.toFixed(2)}}}},plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},elements:{point:{radius:0}}}};this.chart=new w(t,i)},redraw(t){if(!this.chart)return;this.chart.data.labels=t.tau.map(i=>i.toFixed(2));const n=[];t.f&&n.push({label:"f(τ)",data:t.f,borderColor:"rgb(59, 130, 246)",borderWidth:2,tension:.1}),t.g&&n.push({label:"g(t-τ)",data:t.g,borderColor:"rgb(34, 197, 94)",borderWidth:2,tension:.1}),t.product&&n.push({label:"f(τ)·g(t-τ)",data:t.product,borderColor:"rgb(168, 85, 247)",backgroundColor:"rgba(168, 85, 247, 0.2)",borderWidth:1,fill:!0,tension:.1}),this.chart.data.datasets=n,this.chart.update("none")},clear(){this.chart&&(this.chart.data.labels=[],this.chart.data.datasets=[],this.chart.update("none"))}};window.ResultChart={chart:null,init(){const t=document.getElementById("resultChart"),n=document.getElementById("resultContainer");if(!t||!n){console.error("Result chart canvas or container not found!");return}this.chart&&this.chart.destroy(),t.style.width="100%",t.style.height="100%",t.style.maxWidth="100%";const i={type:"line",data:{datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,scales:{x:{type:"linear",title:{display:!0,text:"t"},ticks:{maxTicksLimit:15,callback:function(r){const e=r;return Math.abs(e)<1e-10?"0":Math.abs(e)<.01||Math.abs(e)>1e3?e.toExponential(2):e.toFixed(2)}}},y:{title:{display:!0,text:"(f*g)(t)"},ticks:{callback:function(r){const e=r;return Math.abs(e)<1e-10?"0":Math.abs(e)<.01||Math.abs(e)>1e3?e.toExponential(2):e.toFixed(2)}}}},plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},elements:{point:{radius:0}}}};this.chart=new w(t,i)},redraw(t){if(!this.chart)return;const n=[];if(n.push({label:"(f*g)(t)",data:t.t.map((i,r)=>({x:i,y:t.result[r]})),borderColor:"rgb(239, 68, 68)",backgroundColor:"rgba(239, 68, 68, 0.1)",borderWidth:2,fill:!0,tension:.1,showLine:!0}),t.currentPoint){const i=typeof t.currentPoint.t=="number"?t.currentPoint.t:parseFloat(t.currentPoint.t);n.push({type:"scatter",label:"Punto actual",data:[{x:i,y:t.currentPoint.value}],borderColor:"rgb(251, 191, 36)",backgroundColor:"rgb(251, 191, 36)",pointRadius:8,pointHoverRadius:10,pointStyle:"circle"})}this.chart.data.datasets=n,this.chart.update("none")},clear(){this.chart&&(this.chart.data.labels=[],this.chart.data.datasets=[],this.chart.update("none"))}};
