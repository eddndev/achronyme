import{i as x,v as C,a as I}from"./validation-BT8GwmWI.js";import{e as g,p as F}from"./mathjs-CqmDO44L.js";import{C as D,r as R}from"./chart-Co7ClN-s.js";const O=50;function P(t){try{if(!t||t.length===0)throw new Error("No se proporcionaron funciones para el cálculo.");const e=t.map(i=>{try{return{userFunc:F(i.definition).compile(),a:g(i.domainStart),b:g(i.domainEnd)}}catch(w){throw new Error(`Error al procesar la función "${i.definition}" o sus dominios: ${w.message}`)}}),r=e[0].a,s=e[e.length-1].b-r;if(s<=0)throw new Error("El período total (desde el inicio del primer dominio hasta el fin del último) debe ser positivo.");const l=[],f=[];let c=0;for(const i of e)c+=x(w=>i.userFunc.evaluate({t:w}),i.a,i.b);const o=2/s*c;for(let i=1;i<=O;i++){let w=0,E=0;for(const d of e)w+=x(u=>d.userFunc.evaluate({t:u})*Math.cos(2*Math.PI*i*u/s),d.a,d.b),E+=x(u=>d.userFunc.evaluate({t:u})*Math.sin(2*Math.PI*i*u/s),d.a,d.b);l[i]=2/s*w,f[i]=2/s*E}return{success:!0,coeffs:{a0:o,an:l,bn:f,period:s,domainStart:r}}}catch(e){return console.error("Error en el cálculo de coeficientes:",e),{success:!1,error:e.message}}}function A(){return{calculationMode:"calculate",isLoading:!1,errorMessage:"",resizeObserver:null,nextId:2,functions:[{id:1,definition:"t",domainStart:"-pi",domainEnd:"pi",definitionError:null,domainStartError:null,domainEndError:null}],piecewiseCoeffs:null,coeff_a0_str:"0",coeff_an_str:"(2*(-1)^(n+1))/n",coeff_bn_str:"0",coeff_a0_error:null,coeff_an_error:null,coeff_bn_error:null,renderOriginal:["original"],renderSeries:["series"],terms_n:10,init(){console.log("[Alpine] Initializing fourierState..."),window.FourierSeriesChart.init({functions:[],renderOriginal:[],renderSeries:[],terms_n:this.terms_n,piecewiseCoeffs:null});const t=document.getElementById("chartContainer");t&&(this.resizeObserver=new ResizeObserver(()=>{window.FourierSeriesChart.chart&&window.FourierSeriesChart.chart.resize()}),this.resizeObserver.observe(t),console.log("[Alpine] ResizeObserver attached to chart container")),this.calculateAndRedraw(),this.$watch("renderOriginal",()=>this.prepareAndRedraw(!1)),this.$watch("renderSeries",()=>this.prepareAndRedraw(!1)),this.$watch("terms_n",()=>this.prepareAndRedraw(!1)),this.$watch("calculationMode",e=>{e==="coefficients"?this.renderOriginal=[]:this.renderOriginal=["original"],this.prepareAndRedraw(!1)})},addFunction(){const t=this.functions[this.functions.length-1];this.functions.push({id:this.nextId++,definition:"0",domainStart:t.domainEnd,domainEnd:"",definitionError:null,domainStartError:null,domainEndError:null})},removeFunction(t){if(this.functions.length>1){const e=this.functions.findIndex(r=>r.id===t);if(e>-1){if(e>0&&e<this.functions.length-1){const r=this.functions[e-1],n=this.functions[e+1];n&&(n.domainStart=r.domainEnd)}this.functions=this.functions.filter(r=>r.id!==t)}}},validate(){this.errorMessage="";let t=!1;if(this.functions.forEach(e=>{e.definitionError=null,e.domainStartError=null,e.domainEndError=null}),this.functions.length===0)return this.errorMessage="Debe haber al menos una función definida.",!1;for(let e=0;e<this.functions.length;e++){const r=this.functions[e],n=I(r.definition);n.isValid||(r.definitionError=n.error,t=!0);const s=C(r.domainStart);s.isValid||(r.domainStartError=s.error,t=!0);const l=C(r.domainEnd);if(l.isValid||(r.domainEndError=l.error,t=!0),e>0){const f=this.functions[e-1];try{if(C(f.domainEnd).isValid&&C(r.domainStart).isValid){const c=g(f.domainEnd),o=g(r.domainStart);if(c!==o){t=!0;const i=`Debe coincidir con el dominio anterior (${c})`;r.domainStartError=r.domainStartError?`${r.domainStartError}. ${i}`:i}}}catch{}}}return!t},validateCoefficients(){this.errorMessage="";let t=!1;this.coeff_a0_error=null,this.coeff_an_error=null,this.coeff_bn_error=null;const e=C(this.coeff_a0_str);e.isValid||(this.coeff_a0_error=e.error,t=!0);const r=I(this.coeff_an_str,"n");r.isValid||(this.coeff_an_error=r.error,t=!0);const n=I(this.coeff_bn_str,"n");return n.isValid||(this.coeff_bn_error=n.error,t=!0),!t},async calculateAndRedraw(){if(this.isLoading=!0,this.errorMessage="",window.FourierSeriesChart.resetScales(),!(this.calculationMode==="calculate"?this.validate():this.validateCoefficients())){this.isLoading=!1;return}try{if(this.calculationMode==="calculate"){const e=P(this.functions);if(e.success)this.piecewiseCoeffs=e.coeffs;else throw new Error(e.error||"Ocurrió un error desconocido.")}else if(this.evaluateCoefficientExpressions(),this.errorMessage){this.isLoading=!1;return}window.FourierSeriesChart.redraw(this.getChartData())}catch(e){console.error("[Alpine] Calculation Error:",e),this.errorMessage=e.message,this.piecewiseCoeffs=null,window.FourierSeriesChart.redraw(this.getChartData())}finally{this.isLoading=!1}},evaluateCoefficientExpressions(){try{this.errorMessage="";const t=-Math.PI,r=Math.PI-t;if(r<=0)throw new Error("El período total debe ser positivo.");const n=g(this.coeff_a0_str),s=F(this.coeff_an_str).compile(),l=F(this.coeff_bn_str).compile(),f=[],c=[];for(let o=1;o<=50;o++)f[o]=s.evaluate({n:o}),c[o]=l.evaluate({n:o});this.piecewiseCoeffs={a0:n,an:f,bn:c,period:r,domainStart:t}}catch(t){this.errorMessage=`Error en la expresión del coeficiente: ${t.message}`,this.piecewiseCoeffs=null}},prepareAndRedraw(t=!0){if(t){this.calculateAndRedraw();return}window.FourierSeriesChart.redraw(this.getChartData())},getChartData(){return{functions:this.functions,renderOriginal:this.renderOriginal,renderSeries:this.renderSeries,terms_n:this.terms_n,piecewiseCoeffs:this.piecewiseCoeffs}}}}window.fourierState=A;D.register(...R);window.FourierSeriesChart={chart:null,currentMinY:null,currentMaxY:null,resetScales(){this.currentMinY=null,this.currentMaxY=null},init(t){const e=document.getElementById("fourierChart"),r=document.getElementById("chartContainer");if(!e||!r){console.error("Chart canvas or container not found!");return}this.chart&&this.chart.destroy(),this.resetScales(),e.style.width="100%",e.style.height="100%",e.style.maxWidth="100%";const n={type:"line",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,resizeDelay:100,scales:{x:{title:{display:!0,text:"t"},ticks:{maxTicksLimit:20}},y:{title:{display:!0,text:"f(t)"}}},plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},elements:{point:{radius:0}}}};this.chart=new D(e,n),this.redraw(t)},redraw(t){if(!this.chart||!t||!t.functions){console.warn("Redraw failed: Chart instance or data is missing."),this.chart&&(this.chart.data.labels=[],this.chart.data.datasets=[],this.chart.update("none"));return}const{functions:e,renderOriginal:r,renderSeries:n,terms_n:s,piecewiseCoeffs:l}=t,f=n.includes("series")&&!!l,c=r.includes("original")&&e.length>0,o=[],i=[],w=500;let E,d;c?(E=e.length>0?g(e[0].domainStart):0,d=e.length>0?g(e[e.length-1].domainEnd):1):f?(E=l.domainStart,d=l.domainStart+l.period):(E=-Math.PI,d=Math.PI);const y=d-E,V=y>0?y/w:.1,u=[];for(let m=E;m<=d;m+=V)u.push(m.toFixed(2));if(c){const m=e.map(a=>{try{return{compiled:F(a.definition).compile(),start:g(a.domainStart),end:g(a.domainEnd)}}catch{return null}}).filter(a=>a!==null),_=[];for(const a of u){const h=parseFloat(a);let M=null;const b=m.find(p=>h>=p.start-1e-9&&h<=p.end+1e-9);if(b){const p=this.evaluateCompiledFunction(b.compiled,h);isFinite(p)&&(M=p,i.push(p))}_.push(M)}o.push({label:"f(t)",data:_,borderColor:"rgb(59, 130, 246)",borderWidth:2,borderDash:[5,5],tension:.1})}if(f){const{a0:m,an:_,bn:a,period:h}=l,M=[];for(const b of u){const p=parseFloat(b);let v=m/2;for(let S=1;S<=s;S++)_[S]!==void 0&&a[S]!==void 0&&(v+=_[S]*Math.cos(2*Math.PI*S*p/h),v+=a[S]*Math.sin(2*Math.PI*S*p/h));M.push(v),isFinite(v)&&i.push(v)}o.push({label:`Serie de Fourier (N=${s})`,data:M,borderColor:"rgb(220, 38, 38)",borderWidth:2,tension:.1})}if(i.length>0){let m=Math.min(...i),_=Math.max(...i);(this.currentMinY===null||m<this.currentMinY)&&(this.currentMinY=m),(this.currentMaxY===null||_>this.currentMaxY)&&(this.currentMaxY=_);let a=this.currentMinY,h=this.currentMaxY;a===h&&(a-=1,h+=1);const b=(h-a)*.1;this.chart.options.scales?.y&&(this.chart.options.scales.y.min=a-b,this.chart.options.scales.y.max=h+b)}else this.resetScales(),this.chart.options.scales?.y&&(delete this.chart.options.scales.y.min,delete this.chart.options.scales.y.max);this.chart.data.labels=u,this.chart.data.datasets=o,this.chart.update("none")},evaluateCompiledFunction(t,e){try{const r=t.evaluate({t:e,pi:Math.PI});return typeof r=="number"&&isFinite(r)?r:NaN}catch(r){return console.error("Error evaluating compiled function:",r),NaN}}};
